<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SPIRAL IN</title>

<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;overflow:hidden;font-family:system-ui,Arial,sans-serif;}
  .wrap{height:100%;display:grid;place-items:center;}
  .stage{position:relative;width:min(92vw,900px);aspect-ratio:16/9;border-radius:18px;overflow:hidden;background:#000;box-shadow:0 0 60px rgba(0,0,0,.8);}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);filter: grayscale(100%) contrast(1.16) brightness(1.06);}

  .hud{position:absolute;inset:0;display:grid;grid-template-rows:auto 1fr auto;padding:18px;z-index:10;pointer-events:none;}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;user-select:none;}
  .instruction{pointer-events:none;display:inline-flex;align-items:center;padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.72);color:#000;font-size:11px;letter-spacing:.18em;text-transform:uppercase;box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);white-space:nowrap;}
  .topRight{display:flex;align-items:center;gap:10px;pointer-events:auto;}
  .clock{font-size:11px;letter-spacing:.16em;text-transform:uppercase;opacity:.55;}
  .stopTop{border:0;border-radius:999px;padding:10px 12px;background:rgba(255,255,255,.10);color:#fff;font-size:11px;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);}
  .stopTop:hover{ background:rgba(255,255,255,.16); }
  .stopTop[disabled]{ opacity:.35; cursor:not-allowed; }

  .center{align-self:center;justify-self:center;background:rgba(0,0,0,.62);padding:24px 22px;border-radius:16px;text-align:center;pointer-events:auto;transition: transform 700ms cubic-bezier(.14,.9,.18,1), opacity 520ms ease, filter 700ms ease;box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);max-width:min(86vw,640px);}
  body.mirroring .center{transform:translateY(-60vh);opacity:0;filter:blur(2px);pointer-events:none;}
  h1{margin:0 0 10px;letter-spacing:.2em;text-transform:uppercase;font-size:22px;}
  p{margin:0 0 16px;opacity:.72;font-size:13px;line-height:1.45;}
  .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
  button,.btn{border:0;border-radius:999px;padding:10px 14px;background:rgba(255,255,255,.10);color:#fff;font-size:11px;letter-spacing:.15em;text-transform:uppercase;cursor:pointer;box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);}
  button:hover,.btn:hover{ background:rgba(255,255,255,.18); }
  button[disabled],.btn[disabled]{ opacity:.35; cursor:not-allowed; }
  .hint{margin-top:12px;font-size:12px;opacity:.58;letter-spacing:.10em;user-select:none;}

  .fail{margin-top:6px;font-size:11px;opacity:0;letter-spacing:.12em;text-transform:uppercase;color:rgba(255,255,255,.55);transition: opacity 1.2s ease;user-select:none;}
  .fail.show{ opacity:1; }

  .bottom{display:flex;justify-content:space-between;font-size:11px;letter-spacing:.15em;text-transform:uppercase;opacity:.55;user-select:none;}

  .portal{position:absolute;inset:0;pointer-events:none;opacity:0;z-index:50;}
  .portal.on{opacity:1;animation: fall 5600ms cubic-bezier(.10,.92,.16,1) forwards;}
  .portal::before{
    content:"";
    position:absolute;
    inset:-35%;
    background: repeating-radial-gradient(circle,#fff 0px,#fff 7px,#000 7px,#000 22px);
    transform-origin: 50% 50%;
    animation: slowSpin 42000ms linear infinite, slowBreath 8200ms ease-in-out infinite;
    filter: contrast(1.22);
    mask-image: radial-gradient(circle,#000 0%,#000 72%,transparent 90%);
    -webkit-mask-image: radial-gradient(circle,#000 0%,#000 72%,transparent 90%);
  }
  .portal::after{content:"";position:absolute;inset:0;background:radial-gradient(circle,rgba(0,0,0,0) 0%,rgba(0,0,0,.28) 58%,#000 100%);}

  @keyframes slowSpin{from{transform:rotate(0deg) scale(0.95);}to{transform:rotate(360deg) scale(1.06);}}
  @keyframes slowBreath{0%{filter:contrast(1.12) brightness(1.00);}50%{filter:contrast(1.28) brightness(1.04);}100%{filter:contrast(1.12) brightness(1.00);}}
  @keyframes fall{0%{transform:scale(1.0);filter:blur(0px);}30%{transform:scale(1.05);filter:blur(0.20px);}65%{transform:scale(1.18);filter:blur(0.55px);}100%{transform:scale(2.00);filter:blur(1.25px);}}

  /* ===== Key Reveal ===== */
  .keyReveal{position:absolute;inset:0;display:grid;place-items:center;z-index:90;pointer-events:none;opacity:0;transition: opacity 420ms ease;}
  .keyReveal.on{opacity:1;pointer-events:auto;}
  .keyReveal::before{
    content:"";
    position:absolute;
    inset:-18%;
    opacity:.14;
    background:repeating-radial-gradient(circle,rgba(255,255,255,1) 0px,rgba(255,255,255,1) 2px,rgba(0,0,0,1) 2px,rgba(0,0,0,1) 20px);
    transform: rotate(7deg) scale(1.2);
    filter: blur(0.35px) contrast(1.05);
  }
  .keyCard{position:relative;width:min(88vw,760px);border-radius:18px;padding:22px 20px;background:rgba(0,0,0,.66);box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);}
  .keyTitle{margin:0 0 8px;font-size:12px;letter-spacing:.22em;text-transform:uppercase;opacity:.80;}
  .keyValue{margin:0 0 12px;font-size: clamp(16px, 2.6vw, 26px);letter-spacing:.12em;line-height:1.35;padding:14px 14px;border-radius:14px;background:rgba(255,255,255,.06);box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);user-select:text;word-break:break-all;}
  .keyCta{margin:0 0 14px;font-size:11px;letter-spacing:.14em;text-transform:uppercase;opacity:.78;line-height:1.35;}
  .keyNote{margin:0 0 14px;font-size:11px;letter-spacing:.14em;text-transform:uppercase;opacity:.62;line-height:1.35;}
  .keyRow{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
  .copyBtn{pointer-events:auto;}
  .copied{font-size:11px;letter-spacing:.14em;text-transform:uppercase;opacity:0;transition: opacity 260ms ease;align-self:center;}
  .copied.show{opacity:.62;}

  /* ===== Coward “page” (Stop 1-2) — ritual chat ===== */
  .cowardPage{position:absolute;inset:0;background:#000;z-index:100;display:none;overflow:hidden;align-items:center;justify-content:center;pointer-events:auto;}
  body.coward .cowardPage{ display:flex; }
  .cowardPage::before{
    content:"";
    position:absolute;
    inset:-18%;
    opacity:.14;
    background:repeating-radial-gradient(circle,rgba(255,255,255,1) 0px,rgba(255,255,255,1) 2px,rgba(0,0,0,1) 2px,rgba(0,0,0,1) 20px);
    transform: rotate(-8deg) scale(1.2);
    filter: blur(0.35px) contrast(1.05);
  }

  .cowardInner{
    position:relative;
    text-align:left;
    padding:22px 20px;
    border-radius:18px;
    background:rgba(0,0,0,.62);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    max-width:min(90vw,760px);
    width:min(90vw,760px);
    display:flex;
    flex-direction:column;
    gap:0;
  }

  .cowardTitle{margin:0 0 6px;font-size:18px;letter-spacing:.18em;text-transform:uppercase;}
  .cowardSub{margin:0 0 6px;opacity:.70;letter-spacing:.10em;text-transform:uppercase;font-size:11px;line-height:1.35;}
  .rules{margin:0 0 14px;font-size:10px;letter-spacing:.18em;text-transform:uppercase;opacity:.50;user-select:none;}

  .chat{
    flex:1;
    min-height:min(42vh,320px);
    max-height:min(42vh,320px);
    overflow:auto;
    padding:12px;
    border-radius:14px;
    background:rgba(255,255,255,.04);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    margin-bottom:12px;
  }

  .bubble{max-width:82%;padding:10px 12px;border-radius:14px;margin:8px 0;font-size:12px;line-height:1.45;letter-spacing:.02em;white-space:pre-wrap;word-wrap:break-word;}
  .bubble.user{margin-left:auto;background:rgba(255,255,255,.10);box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);}
  .bubble.system{margin-right:auto;background:rgba(0,0,0,.35);box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);opacity:.92;}
  .bubble.typing{margin-right:auto;background:rgba(0,0,0,.22);box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);opacity:.70;font-style:italic;letter-spacing:.10em;}

  .label{font-size:11px;letter-spacing:.16em;text-transform:uppercase;opacity:.72;margin:0 0 6px;}
  .inputRow{display:flex;gap:10px;align-items:flex-end;}
  textarea{flex:1;resize:none;min-height:52px;max-height:140px;padding:12px 12px;border-radius:14px;border:0;outline:none;background:rgba(255,255,255,.06);color:#fff;font-size:12px;line-height:1.45;box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);}
  .enterBtn{padding:12px 14px;border-radius:14px;background:rgba(255,255,255,.10);min-width:88px;height:52px;display:inline-flex;align-items:center;justify-content:center;}
  .ghostBtn{background:rgba(255,255,255,.08);}

  .readyGate{display:none;margin-top:0;padding:12px;border-radius:14px;background:rgba(255,255,255,.04);box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);}
  .readyGate.show{display:block;}
  .readyPrompt{margin:0 0 10px;font-size:11px;letter-spacing:.16em;text-transform:uppercase;opacity:.75;line-height:1.35;}
  .readyRow{display:flex;gap:10px;align-items:flex-end;}
  input[type="text"]{flex:1;height:44px;padding:0 12px;border-radius:12px;border:0;outline:none;background:rgba(255,255,255,.06);color:#fff;font-size:12px;letter-spacing:.10em;text-transform:uppercase;box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);}

  .cowardInner.readyMode .label,
  .cowardInner.readyMode .inputRow{display:none;}

  /* ===== LOCKED after 3 Stops ===== */
  .lockedPage{position:absolute;inset:0;background:#000;z-index:120;display:none;overflow:hidden;align-items:center;justify-content:center;pointer-events:auto;}
  body.locked .lockedPage{ display:flex; }
  .lockedPage::before{
    content:"";
    position:absolute;
    inset:-20%;
    opacity:.10;
    background:repeating-radial-gradient(circle,rgba(255,255,255,1) 0px,rgba(255,255,255,1) 2px,rgba(0,0,0,1) 2px,rgba(0,0,0,1) 18px);
    transform: rotate(9deg) scale(1.25);
    filter: blur(0.35px) contrast(1.1);
  }
  .lockedInner{position:relative;text-align:center;padding:30px 22px;border-radius:18px;background:rgba(0,0,0,.62);box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);backdrop-filter: blur(10px);-webkit-backdrop-filter: blur(10px);max-width:min(86vw,760px);}
  .lockedInner h2{margin:0 0 12px;font-size: clamp(44px, 7vw, 96px);letter-spacing:.22em;text-transform:uppercase;line-height:1;}
  .lockedInner .small{margin:0 0 18px;opacity:.62;letter-spacing:.12em;text-transform:uppercase;font-size:12px;line-height:1.35;}
  .lockedInner a{display:inline-block;border-radius:999px;padding:12px 16px;background:rgba(255,255,255,.12);color:#fff;font-size:11px;letter-spacing:.15em;text-transform:uppercase;text-decoration:none;box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);}
  .lockedInner a:hover{background:rgba(255,255,255,.18);}

  @media(max-width:520px){
    .stage{aspect-ratio:9/16;}
    body.mirroring .center{transform:translateY(-80vh);}
    .instruction{font-size:10px;letter-spacing:.14em;padding:9px 10px;}
    .chat{min-height:min(46vh,360px);max-height:min(46vh,360px);}
    .enterBtn{min-width:78px;}
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="stage">
    <video id="vid" autoplay muted playsinline></video>

    <div class="portal" id="portal"></div>

    <!-- Key reveal -->
    <div class="keyReveal" id="keyReveal" aria-hidden="true">
      <div class="keyCard">
        <div class="keyTitle">KEY REVEALED</div>
        <div class="keyValue" id="keyValue">1thevoidlooksback1</div>
        <div class="keyCta">DM @photonisdead to claim, only the first will be rewarded</div>
        <div class="keyNote">Do not share it. Carry it with you.</div>
        <div class="keyRow">
          <div class="copied" id="copied">Copied.</div>
          <button class="copyBtn" id="copyBtn">Copy</button>
        </div>
      </div>
    </div>

    <!-- Coward page (Stop #1 and #2) -->
    <div class="cowardPage" id="cowardPage">
      <div class="cowardInner" id="cowardInner">
        <div class="cowardTitle">What are you avoiding</div>
        <div class="cowardSub">Is the mirror hard to look at?</div>
        <div class="rules">Short sentences. No explaining.</div>

        <div class="chat" id="chat"></div>

        <div class="label">Confess.</div>
        <div class="inputRow" id="inputRow">
          <textarea id="confession" placeholder="Enter to send. Shift+Enter for a new line."></textarea>
          <button class="enterBtn" id="enterBtn">Enter</button>
        </div>

        <!-- RETURN ritual (only path back) -->
        <div class="readyGate" id="readyGate">
          <div class="readyPrompt" id="readyPrompt">Are you ready to go back?<br>Type RETURN.</div>
          <div class="readyRow">
            <input id="returnInput" type="text" inputmode="text" autocomplete="off" spellcheck="false" placeholder="RETURN">
            <button class="enterBtn" id="returnBtn">Enter</button>
            <button class="ghostBtn" id="stayBtn">Stay</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Locked after 3 Stops -->
    <div class="lockedPage" id="lockedPage">
      <div class="lockedInner">
        <h2>LOCKED</h2>
        <div class="small">You chose the exit three times.<br>The gate will not open.</div>
        <a href="#return" id="returnLink">Return and try again</a>
      </div>
    </div>

    <!-- Main HUD -->
    <div class="hud">
      <div class="top">
        <div class="instruction">HOLD STILL, BE PRESENT</div>
        <div class="topRight">
          <div class="clock" id="clock">—</div>
          <button class="stopTop" id="stopTop" disabled>Stop</button>
        </div>
      </div>

      <div class="center">
        <h1>Spiral in.</h1>
        <p id="sub">The gate opens in reflection.</p>
        <div class="row">
          <button id="start">Enable Mirror</button>
        </div>
        <div class="hint" id="hint">Hold still.</div>
        <div class="fail" id="fail"></div>
      </div>

      <div class="bottom">
        <div id="status">Mirror idle</div>
        <div></div>
      </div>
    </div>

  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const MANIFOLD_URL = "https://manifold.xyz/@photon-tide/contract/144597232/11";
  const SECRET_KEY   = "1thevoidlooksback1";

  // =========================
  // ULTRA STRICT STILLNESS
  // =========================
  const NEED = 7000;              // 7 seconds
  const STILL_THRESH = 3.8;       // lower = stricter
  const WARMUP_FRAMES = 24;
  const REQUIRE_CONSEC_FRAMES = 90;

  const PORTAL_DELAY = 240;
  const KEY_REVEAL_AT_MS = 4000;
  const KEY_HOLD_MS      = 4500;
  const AUDIO_FADE_MS    = 1600;
  const REDIRECT_AFTER   = KEY_REVEAL_AT_MS + KEY_HOLD_MS + 600;

  // Chat feel (typing delay)
  const TYPE_MIN_MS = 520;
  const TYPE_MAX_MS = 1100;

  // Invisible rule thresholds
  const STOP_IMMEDIATE_MS = 1500;    // stop pressed within this = colder entry
  const LONG_CONFESSION_CHARS = 220; // long = shorter replies

  const vid = document.getElementById("vid");
  const startBtn = document.getElementById("start");
  const stopTop = document.getElementById("stopTop");
  const hint = document.getElementById("hint");
  const sub = document.getElementById("sub");
  const statusEl = document.getElementById("status");
  const portal = document.getElementById("portal");
  const clock = document.getElementById("clock");

  const keyReveal = document.getElementById("keyReveal");
  const keyValue  = document.getElementById("keyValue");
  const copyBtn   = document.getElementById("copyBtn");
  const copied    = document.getElementById("copied");
  keyValue.textContent = SECRET_KEY;

  copyBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(SECRET_KEY);
      copied.classList.add("show");
      setTimeout(()=>copied.classList.remove("show"), 1100);
    }catch(_){
      const r=document.createRange();
      r.selectNodeContents(keyValue);
      const s=window.getSelection();
      s.removeAllRanges(); s.addRange(r);
      copied.textContent="Select & copy.";
      copied.classList.add("show");
      setTimeout(()=>{copied.textContent="Copied.";copied.classList.remove("show");s.removeAllRanges();}, 1200);
    }
  });

  // Coward chat elements
  const chatEl = document.getElementById("chat");
  const confessionEl = document.getElementById("confession");
  const enterBtn = document.getElementById("enterBtn");
  const readyGate = document.getElementById("readyGate");
  const returnInput = document.getElementById("returnInput");
  const returnBtn = document.getElementById("returnBtn");
  const stayBtn = document.getElementById("stayBtn");
  const cowardInner = document.getElementById("cowardInner");

  // ===== Versioned storage reset =====
  const STORAGE_VERSION = "spiral_gate_v14_memory_invisible_rules";
  const VERSION_KEY = "spiral_storage_version";
  if (localStorage.getItem(VERSION_KEY) !== STORAGE_VERSION){
    localStorage.setItem(VERSION_KEY, STORAGE_VERSION);
    localStorage.setItem("spiral_stop_count", "0");
    localStorage.removeItem("spiral_locked");
    localStorage.removeItem("spiral_coward_chat_state");
    localStorage.removeItem("spiral_fail_count");
    localStorage.removeItem("spiral_coward_visits");
    localStorage.removeItem("spiral_left_early");
  }

  // ===== “Remembering” flags (light consequence across sessions) =====
  const VISITS_KEY = "spiral_coward_visits";
  const LEFT_EARLY_KEY = "spiral_left_early"; // 1 means they previously opened coward and didn’t complete RETURN
  let cowardVisits = Number(localStorage.getItem(VISITS_KEY) || 0);
  if (!Number.isFinite(cowardVisits)) cowardVisits = 0;

  function markLeftEarly(){
    localStorage.setItem(LEFT_EARLY_KEY, "1");
  }
  function clearLeftEarly(){
    localStorage.removeItem(LEFT_EARLY_KEY);
  }
  function hasLeftEarly(){
    return localStorage.getItem(LEFT_EARLY_KEY) === "1";
  }

  // ===== Fail whisper =====
  const failEl = document.getElementById("fail");
  const FAIL_KEY = "spiral_fail_count";
  let failCount = Number(localStorage.getItem(FAIL_KEY) || 0);
  if (!Number.isFinite(failCount)) failCount = 0;

  const failMessages = ["You weren’t ready.","Return when quiet.","The spiral remembers."];

  function showFail(){
    if (failCount < 3){ failEl.textContent=""; failEl.classList.remove("show"); return; }
    const idx = Math.min(failMessages.length-1, failCount-3);
    failEl.textContent = failMessages[idx];
    failEl.classList.add("show");
  }
  function registerFail(){ failCount++; localStorage.setItem(FAIL_KEY,String(failCount)); showFail(); }
  function clearFail(){ failCount=0; localStorage.removeItem(FAIL_KEY); failEl.textContent=""; failEl.classList.remove("show"); }

  // ===== Stop lockout after 3 stops =====
  const STOP_KEY="spiral_stop_count";
  const LOCK_KEY="spiral_locked";
  let stopCount=Number(localStorage.getItem(STOP_KEY)||0); if(!Number.isFinite(stopCount)) stopCount=0;
  let locked=(localStorage.getItem(LOCK_KEY)==="1");

  function applyLockedUI(){
    if(locked){
      document.body.classList.add("locked");
      startBtn.disabled=true;
      stopTop.disabled=true;
      statusEl.textContent="Locked";
      hint.textContent="Return and try again.";
      sub.textContent="The gate will not open.";
    }else{
      document.body.classList.remove("locked");
    }
  }

  function lockNow(){
    locked=true;
    localStorage.setItem(LOCK_KEY,"1");
    document.body.classList.add("locked");
    stopCam();
    applyLockedUI();
  }

  function unlockNow(){
    locked=false;
    stopCount=0;
    localStorage.setItem(STOP_KEY,"0");
    localStorage.removeItem(LOCK_KEY);
    document.body.classList.remove("locked");
    document.body.classList.remove("coward");
    location.hash="";
    resetGate();
    applyLockedUI();
    statusEl.textContent="Mirror idle";
    hint.textContent="Hold still.";
    sub.textContent="The gate opens in reflection.";
    showFail();
  }

  function registerStop(){
    stopCount++;
    localStorage.setItem(STOP_KEY,String(stopCount));
    if(stopCount>=3){ lockNow(); return true; }
    return false;
  }

  // ===== Camera + loop =====
  let stream=null, raf=null;

  // Motion detection canvas
  const mCan=document.createElement("canvas");
  mCan.width=160; mCan.height=90;
  const mCtx=mCan.getContext("2d",{willReadFrequently:true});

  let last=null;
  let stillMs=0;
  let stillStreak=0;
  let triggered=false;
  let warmup=0;

  // track mirror start for “stop immediately” invisible rule
  let mirrorStartAt = 0;
  let lastStopImmediate = false;

  // ===== Ambient sound (procedural) =====
  let audioCtx=null, master=null, droneOsc=null, shimmerOsc=null, lfo=null, lfoGain=null;

  function startAmbient(){
    if(audioCtx) return;
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    master=audioCtx.createGain(); master.gain.value=0.0; master.connect(audioCtx.destination);

    droneOsc=audioCtx.createOscillator(); droneOsc.type="sine"; droneOsc.frequency.value=46;
    const droneGain=audioCtx.createGain(); droneGain.gain.value=0.28;

    shimmerOsc=audioCtx.createOscillator(); shimmerOsc.type="triangle"; shimmerOsc.frequency.value=176;
    const shimmerGain=audioCtx.createGain(); shimmerGain.gain.value=0.045;

    lfo=audioCtx.createOscillator(); lfo.type="sine"; lfo.frequency.value=0.06;
    lfoGain=audioCtx.createGain(); lfoGain.gain.value=9.5;
    lfo.connect(lfoGain); lfoGain.connect(droneOsc.frequency);

    droneOsc.connect(droneGain); shimmerOsc.connect(shimmerGain);
    droneGain.connect(master); shimmerGain.connect(master);
    droneOsc.start(); shimmerOsc.start(); lfo.start();

    master.gain.setValueAtTime(0.0,audioCtx.currentTime);
    master.gain.linearRampToValueAtTime(0.22,audioCtx.currentTime+1.2);
  }

  function fadeOutAmbient(ms){
    if(!audioCtx||!master) return;
    const t=audioCtx.currentTime;
    const dur=Math.max(0.05,ms/1000);
    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(master.gain.value,t);
    master.gain.linearRampToValueAtTime(0.0001,t+dur);
    try{
      shimmerOsc.frequency.cancelScheduledValues(t);
      shimmerOsc.frequency.setTargetAtTime(140,t,1.0);
    }catch(_){}
  }

  function stopAmbient(){
    if(!audioCtx) return;
    const t=audioCtx.currentTime;
    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(master.gain.value,t);
    master.gain.linearRampToValueAtTime(0.0,t+0.35);
    setTimeout(()=>{
      try{droneOsc?.stop();shimmerOsc?.stop();lfo?.stop();}catch(_){}
      audioCtx.close().catch(()=>{});
      audioCtx=null; master=null; droneOsc=null; shimmerOsc=null; lfo=null; lfoGain=null;
    },450);
  }

  function setClock(){
    const d=new Date();
    clock.textContent=d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0")+":"+d.getSeconds().toString().padStart(2,"0");
  }
  setClock(); setInterval(setClock,350);

  function resetGate(){
    portal.classList.remove("on");
    keyReveal.classList.remove("on");
    keyReveal.setAttribute("aria-hidden","true");
    triggered=false;
    stillMs=0;
    stillStreak=0;
    last=null;
    warmup=0;
  }

  function showKeyReveal(){
    keyReveal.classList.add("on");
    keyReveal.setAttribute("aria-hidden","false");
    setTimeout(()=>copyBtn.focus?.(),120);
  }

  function beginPortal(){
    if(triggered || locked) return;
    triggered=true;

    if (raf) cancelAnimationFrame(raf);
    raf=null;

    // success clears “unfinished” memory
    clearLeftEarly();

    clearFail();
    stopCount=0;
    localStorage.setItem(STOP_KEY,"0");

    hint.textContent="Falling inward.";
    sub.textContent="Recognized.";

    if(audioCtx && master){
      const t=audioCtx.currentTime;
      master.gain.cancelScheduledValues(t);
      master.gain.setValueAtTime(master.gain.value,t);
      master.gain.linearRampToValueAtTime(0.30,t+0.9);
    }

    setTimeout(()=>{
      portal.classList.add("on");

      setTimeout(showKeyReveal, KEY_REVEAL_AT_MS);

      const fadeAt = Math.max(0, REDIRECT_AFTER - AUDIO_FADE_MS);
      setTimeout(()=>fadeOutAmbient(AUDIO_FADE_MS), fadeAt);

      setTimeout(()=>{ window.location.href = MANIFOLD_URL; }, REDIRECT_AFTER);

    }, PORTAL_DELAY);
  }

  async function startCam(){
    if(locked){ applyLockedUI(); return; }

    resetGate();
    document.body.classList.remove("coward");
    document.body.classList.remove("mirroring");

    showFail();

    try{
      startAmbient();
      stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
      vid.srcObject=stream;
      await vid.play();

      startBtn.disabled=true;
      stopTop.disabled=false;

      statusEl.textContent="Mirror active";
      hint.textContent="Hold still. Be present.";
      sub.textContent="The gate opens in reflection.";

      document.body.classList.add("mirroring");

      mirrorStartAt = performance.now();
      lastStopImmediate = false;

      lastT=performance.now();
      loop();
    }catch(e){
      statusEl.textContent="Denied";
      hint.textContent="Reflection required.";
      startBtn.disabled=false;
      stopTop.disabled=true;
      registerFail();
      stopAmbient();
    }
  }

  function stopCam(){
    if(raf) cancelAnimationFrame(raf);
    raf=null;

    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream=null;

    startBtn.disabled = locked ? true : false;
    stopTop.disabled = true;

    statusEl.textContent = locked ? "Locked" : "Mirror stopped";
    hint.textContent = locked ? "Return and try again." : "Look inward.";

    document.body.classList.remove("mirroring");
    resetGate();
    stopAmbient();
  }

  // =========================
  // Ritual Chat (memory + invisible rules)
  // =========================
  const CHAT_KEY="spiral_coward_chat_state";
  let chatState = JSON.parse(localStorage.getItem(CHAT_KEY)||"null") || { turns:0, stage:0, readyAsked:false };
  const saveChatState=()=>localStorage.setItem(CHAT_KEY,JSON.stringify(chatState));
  const scrollChat=()=>{ chatEl.scrollTop=chatEl.scrollHeight; };

  function addBubble(text,who){
    const div=document.createElement("div");
    div.className="bubble "+who;
    div.textContent=text;
    chatEl.appendChild(div);
    scrollChat();
    return div;
  }
  function addTyping(){ return addBubble("…","typing"); }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // “Remembering” openers
  const OPENERS_FIRST = [
    ["You looked away.","Name the thing you refused to face."]
  ];
  const OPENERS_RETURNED = [
    ["You again.","Still circling."],
    ["Still circling.","Say what you wouldn’t say."],
    ["You didn’t finish last time.","Name it."]
  ];
  const OPENERS_COLD = [
    ["You didn’t stay long.","Say it."],
    ["You left quickly.","Short sentence."],
    ["You ran.","Name what you ran from."]
  ];

  function seedChatIfEmpty(){
    if(chatEl.children.length) return;

    // decide which opener to use
    const returned = hasLeftEarly() || cowardVisits >= 1;
    const cold = !!lastStopImmediate;

    let pair;
    if (cold) pair = pick(OPENERS_COLD);
    else if (returned) pair = pick(OPENERS_RETURNED);
    else pair = pick(OPENERS_FIRST);

    addBubble(pair[0], "system");
    addBubble(pair[1], "system");
  }

  function cleanWords(text){
    return (text||"").toLowerCase().replace(/[^a-z0-9\s'’-]/g," ").split(/\s+/).filter(Boolean);
  }
  function pickFragment(text){
    const w=cleanWords(text).filter(x=>x.length>=4);
    if(!w.length) return "";
    const pick=w[Math.max(0,w.length-2)];
    return pick ? `"${pick}"` : "";
  }

  // Invisible rule: caps detection
  function isMostlyCaps(text){
    const letters = (text || "").match(/[A-Za-z]/g) || [];
    if (letters.length < 6) return false;
    const upper = letters.filter(ch => ch === ch.toUpperCase()).length;
    return (upper / letters.length) >= 0.72;
  }

  // Themes
  const THEMES = [
    { keys:["anxiety","panic","stress","worried","worry","overthink","fear","scared","terrified","nervous"],
      identify:["What is the danger you keep rehearsing?","What are you bracing for?"],
      pressure:["If it happened right now, what would you do first?","If you stopped scanning for it, what would you notice instead?"] },
    { keys:["avoid","avoiding","procrastinate","later","tomorrow","stall","stuck","paralyzed","freeze","postpone"],
      identify:["What do you do instead of beginning?","What do you call it when you delay on purpose?"],
      pressure:["If you started tonight, what would collapse?","What would you lose if you stopped delaying?"] },
    { keys:["shame","guilt","regret","embarrassed","humiliated","fault","blame","sorry","mistake"],
      identify:["What is the simplest version of it?","What do you keep trying to erase?"],
      pressure:["If you said it out loud, who would you become?","What would change if you forgave yourself first?"] },
    { keys:["love","relationship","breakup","heart","miss","attachment","alone","lonely"],
      identify:["Who are you still circling?","What are you hoping they prove about you?"],
      pressure:["If they never returned, what stays unresolved?","What part of you keeps waiting?"] },
    { keys:["money","rent","bills","debt","job","career","work","income"],
      identify:["What number keeps haunting you?","What does “enough” look like in silence?"],
      pressure:["If the numbers vanished, what would remain?","What do you fear you’ll become without control?"] },
    { keys:["identity","self","worth","confidence","insecure","imposter","meaning","purpose"],
      identify:["Who are you when nobody watches?","What do you refuse to be?"],
      pressure:["If you stopped performing, what would remain?","What truth changes you if you admit it?"] },
    { keys:["angry","anger","mad","rage","resent","betrayed"],
      identify:["What is your anger protecting?","Who did you learn silence from?"],
      pressure:["If you stopped holding it, what would you feel underneath?","Who benefits from you staying stuck?"] },
    { keys:["tired","exhausted","sleep","insomnia","pain","body","burnout"],
      identify:["Where is the weight in your body?","What part of you is asking to stop?"],
      pressure:["If you rested, what would you have to admit?","What catches up to you in stillness?"] },
    { keys:["death","dying","mortality","grief","lost","loss","gone"],
      identify:["What are you trying to outlive?","Who are you carrying with you?"],
      pressure:["If you accepted it, what would you stop postponing?","What would you do differently this week?"] },
    { keys:["art","create","music","paint","draw","writing","project","nft","drop","make"],
      identify:["What are you smuggling inside the work?","What do you hide behind aesthetic?"],
      pressure:["If the work told the truth, what would it say?","What do you fear the audience will recognize?"] }
  ];

  const GENERIC = {
    identify:["Say it plainly.","Name the center, not the edges.","What is under the story?"],
    pressure:["If you stopped running, what would you feel first?","What happens if you stay with it for one minute?","What are you protecting yourself from?"]
  };

  // Invisible rule: long message -> SHORT replies
  const SHORT_BLUNT = {
    identify:["Too many words.","One sentence.","Name it."],
    pressure:["Stop explaining.","What happens if you stop running?","What are you avoiding?"]
  };

  function bestTheme(text){
    const words=cleanWords(text);
    if(!words.length) return null;
    let best=null, bestScore=0;
    for(const t of THEMES){
      let score=0;
      for(const k of t.keys) if(words.includes(k)) score++;
      if(score>bestScore){ bestScore=score; best=t; }
    }
    return bestScore>0 ? best : null;
  }

  function arcReply(text, opts){
    const frag=pickFragment(text);
    const theme=bestTheme(text);
    const t=theme || GENERIC;

    const opener=(frag && Math.random()<0.70 && !opts.forceShort) ? `You said ${frag}.\n` : "";

    // choose pool based on stage
    if(opts.forceShort){
      if(chatState.stage===0){ chatState.stage=1; return pick(SHORT_BLUNT.identify); }
      if(chatState.stage===1){ chatState.stage=2; return pick(SHORT_BLUNT.pressure); }
      return pick(SHORT_BLUNT.pressure);
    }

    if(chatState.stage===0){ chatState.stage=1; return opener + pick(t.identify||GENERIC.identify); }
    if(chatState.stage===1){ chatState.stage=2; return opener + pick(t.pressure||GENERIC.pressure); }
    return opener + pick(t.pressure||GENERIC.pressure);
  }

  function showReadyGate(){
    chatState.readyAsked=true;
    saveChatState();
    addBubble("Are you ready to go back?","system");
    readyGate.classList.add("show");
    cowardInner.classList.add("readyMode");
    returnInput.value="";
    setTimeout(()=>returnInput.focus(),120);
    scrollChat();
  }

  function hideReadyGate(){
    chatState.readyAsked=false;
    saveChatState();
    readyGate.classList.remove("show");
    cowardInner.classList.remove("readyMode");
  }

  function backFromCoward(){
    // successful ritual return clears “unfinished”
    clearLeftEarly();

    hideReadyGate();
    document.body.classList.remove("coward");
    location.hash="";
    statusEl.textContent="Mirror idle";
    hint.textContent="Hold still.";
    sub.textContent="The gate opens in reflection.";
    showFail();
  }

  function normalizeReturn(s){ return (s||"").toUpperCase().replace(/[^A-Z]/g,""); }

  function attemptReturn(){
    const val=normalizeReturn(returnInput.value);
    if(val==="RETURN"){
      addBubble("Then return.","system");
      hideReadyGate();
      chatState.stage=0; chatState.turns=0;
      saveChatState();
      setTimeout(()=>backFromCoward(),650);
      return;
    }
    addBubble("Not yet.\nType RETURN.","system");
    returnInput.value="";
    returnInput.focus();
  }

  function enterCoward(){
    document.body.classList.add("coward");

    // mark “unfinished” as soon as they enter (cleared only by RETURN or success portal)
    markLeftEarly();

    // increment visits (for remembering)
    cowardVisits += 1;
    localStorage.setItem(VISITS_KEY, String(cowardVisits));

    seedChatIfEmpty();
    if(chatState.readyAsked){
      readyGate.classList.add("show");
      cowardInner.classList.add("readyMode");
      setTimeout(()=>returnInput.focus(),120);
    }else{
      readyGate.classList.remove("show");
      cowardInner.classList.remove("readyMode");
      setTimeout(()=>confessionEl.focus(),120);
    }
  }

  function handleSend(){
    if(locked) return;
    const text=confessionEl.value.trim();
    if(!text) return;

    // if return gate is open and they keep talking, close it (they chose to stay)
    if(chatState.readyAsked){
      hideReadyGate();
      addBubble("Then stay.","system");
    }

    addBubble(text,"user");
    confessionEl.value="";

    const typing=addTyping();
    enterBtn.disabled=true;
    setTimeout(()=>{enterBtn.disabled=false;},280);

    // Invisible rule: ALL CAPS => “Lower your voice.”
    const caps = isMostlyCaps(text);
    const isLong = text.length >= LONG_CONFESSION_CHARS;

    // Decide reply
    let reply;
    if (caps){
      reply = "Lower your voice.";
      // don’t advance arc stage when caps fires (feels like a correction)
    } else {
      reply = arcReply(text, { forceShort: isLong });
    }

    chatState.turns += 1;
    saveChatState();

    const delay=Math.floor(TYPE_MIN_MS + Math.random()*(TYPE_MAX_MS-TYPE_MIN_MS));
    setTimeout(()=>{
      typing.classList.remove("typing");
      typing.classList.add("system");
      typing.textContent=reply;

      // ask “ready” every 2 turns once pressure has begun (stage>=2),
      // and always after the first time stage hits 2
      if(!caps){
        if(chatState.stage===2 && !chatState.readyAsked){
          setTimeout(showReadyGate,520);
        }else if(chatState.stage>=2 && !chatState.readyAsked){
          if(chatState.turns % 2 === 0) setTimeout(showReadyGate,520);
        }
      } else {
        // caps correction can still trigger “ready” later, but not immediately
        if(chatState.stage>=2 && !chatState.readyAsked && (chatState.turns % 2 === 0)){
          setTimeout(showReadyGate,720);
        }
      }

      scrollChat();
    },delay);
  }

  // =========================
  // Stop behavior / routing
  // =========================
  function goCoward(){
    // Invisible rule: stop immediately -> colder chat entry
    const now = performance.now();
    lastStopImmediate = (mirrorStartAt > 0 && (now - mirrorStartAt) <= STOP_IMMEDIATE_MS);

    const nowLocked=registerStop();
    stopCam();

    if(nowLocked){
      location.hash="#locked";
      document.body.classList.add("locked");
      document.body.classList.remove("coward");
      applyLockedUI();
      return;
    }
    location.hash="#coward";
    enterCoward();
  }

  // =========================
  // Motion score (luminance)
  // =========================
  function motionScore(){
    if(!vid.videoWidth || !vid.videoHeight) return 999;

    mCtx.drawImage(vid,0,0,mCan.width,mCan.height);
    const f=mCtx.getImageData(0,0,mCan.width,mCan.height);

    if(!last){ last=f; return 999; }

    const A=f.data, B=last.data;
    let sum=0, count=0;

    for(let i=0;i<A.length;i+=8){
      const yA=(0.2126*A[i] + 0.7152*A[i+1] + 0.0722*A[i+2]);
      const yB=(0.2126*B[i] + 0.7152*B[i+1] + 0.0722*B[i+2]);
      sum += Math.abs(yA - yB);
      count++;
    }

    last=f;
    return sum / Math.max(1,count);
  }

  let lastT=performance.now();
  function loop(){
    if(!stream || locked) return;

    const now=performance.now();
    const dt=now-lastT;
    lastT=now;

    const m=motionScore();

    if(warmup < WARMUP_FRAMES){
      warmup++;
      stillMs=0;
      stillStreak=0;
      raf=requestAnimationFrame(loop);
      return;
    }

    // movement = HARD reset
    if(m >= STILL_THRESH){
      stillMs = 0;
      stillStreak = 0;
    }else{
      stillMs += dt;
      stillStreak += 1;
    }

    if(!triggered){
      if(stillMs < 2000) hint.textContent="Hold still. Be present.";
      else if(stillMs < 4500) hint.textContent="Stay.";
      else if(stillMs < NEED) hint.textContent="…";
      else {
        if(stillStreak >= REQUIRE_CONSEC_FRAMES) beginPortal();
        else { stillMs=0; stillStreak=0; }
      }
    }

    raf=requestAnimationFrame(loop);
  }

  // =========================
  // Routing
  // =========================
  function syncRoute(){
    if(location.hash==="#coward"){
      document.body.classList.add("coward");
      document.body.classList.remove("locked");
      enterCoward();
    }else if(location.hash==="#locked"){
      document.body.classList.add("locked");
      document.body.classList.remove("coward");
    }else if(location.hash==="#return"){
      // unlocking counts as “coming back” but not “finishing”
      unlockNow();
    }else{
      document.body.classList.remove("coward");
      document.body.classList.remove("locked");
    }
  }
  window.addEventListener("hashchange", syncRoute);

  // Controls
  startBtn.onclick=startCam;
  stopTop.onclick=goCoward;

  enterBtn.onclick=handleSend;
  confessionEl.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      handleSend();
    }
  });

  returnBtn.onclick=attemptReturn;
  stayBtn.onclick=()=>{
    hideReadyGate();
    addBubble("Then stay with it.","system");
    confessionEl.focus();
  };
  returnInput.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      attemptReturn();
    }
  });

  document.addEventListener("visibilitychange",()=>{ if(document.hidden) stopCam(); });

  // Load
  if(locked) location.hash="#locked";
  showFail();
  applyLockedUI();
  syncRoute();

  // If they refresh while on the coward page, it should still feel “remembering”
  seedChatIfEmpty();
</script>
</body>
</html>
