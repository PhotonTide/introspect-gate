<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SPIRAL IN</title>

<style>
html,body{
  height:100%;
  margin:0;
  background:#000;
  color:#fff;
  overflow:hidden;
  font-family:system-ui,Arial,sans-serif;
}

.wrap{height:100%;display:grid;place-items:center;}

.stage{
  position:relative;
  width:min(92vw,900px);
  aspect-ratio:16/9;
  border-radius:18px;
  overflow:hidden;
  background:#000;
  box-shadow:0 0 60px rgba(0,0,0,.8);
}

video{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1);
  filter:grayscale(100%) contrast(1.15);
}

/* HUD */

.hud{
  position:absolute;
  inset:0;
  display:grid;
  grid-template-rows:auto 1fr auto;
  padding:18px;
  z-index:10;
  pointer-events:none;
}

.top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.instruction{
  background:rgba(255,255,255,.75);
  color:#000;
  padding:9px 12px;
  border-radius:999px;
  font-size:11px;
  letter-spacing:.18em;
  text-transform:uppercase;
}

.topRight{
  display:flex;
  gap:10px;
  pointer-events:auto;
}

.clock{
  font-size:11px;
  opacity:.55;
  letter-spacing:.15em;
}

.stopTop{
  border:0;
  border-radius:999px;
  padding:9px 12px;
  background:rgba(255,255,255,.1);
  color:#fff;
  font-size:11px;
  letter-spacing:.15em;
  cursor:pointer;
}

.stopTop:hover{background:rgba(255,255,255,.18);}
.stopTop[disabled]{opacity:.35;}

.center{
  align-self:center;
  justify-self:center;
  background:rgba(0,0,0,.6);
  padding:24px;
  border-radius:16px;
  text-align:center;
  pointer-events:auto;
  transition:.7s;
}

body.mirroring .center{
  transform:translateY(-60vh);
  opacity:0;
}

h1{
  margin:0 0 10px;
  letter-spacing:.2em;
  text-transform:uppercase;
}

button{
  border:0;
  border-radius:999px;
  padding:10px 14px;
  background:rgba(255,255,255,.1);
  color:#fff;
  font-size:11px;
  letter-spacing:.15em;
  cursor:pointer;
}

button:hover{background:rgba(255,255,255,.2);}
button[disabled]{opacity:.35;}

.hint{font-size:12px;opacity:.6;}

.bottom{
  display:flex;
  justify-content:space-between;
  font-size:11px;
  opacity:.55;
}

/* Portal */

.portal{
  position:absolute;
  inset:0;
  opacity:0;
  pointer-events:none;
  z-index:40;
}

.portal.on{
  opacity:1;
  animation:fall 5.6s ease forwards;
}

.portal::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
  repeating-radial-gradient(circle,#fff 0,#fff 6px,#000 6px,#000 20px);
  animation:spin 40s linear infinite;
}

@keyframes spin{
  from{transform:rotate(0deg) scale(.95);}
  to{transform:rotate(360deg) scale(1.1);}
}

@keyframes fall{
  to{transform:scale(2);filter:blur(1px);}
}

/* Coward Page */

.cowardPage{
  position:absolute;
  inset:0;
  background:#000;
  display:none;
  z-index:90;
  place-items:center;
}

body.coward .cowardPage{display:grid;}

.cowardInner{
  width:min(90vw,760px);
  background:rgba(0,0,0,.65);
  border-radius:18px;
  padding:22px;
}

.cowardTitle{
  font-size:18px;
  letter-spacing:.18em;
  text-transform:uppercase;
}

.cowardSub{
  font-size:11px;
  opacity:.7;
  letter-spacing:.1em;
  margin-bottom:14px;
}

.chat{
  height:300px;
  overflow:auto;
  background:rgba(255,255,255,.04);
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
}

.bubble{
  max-width:80%;
  padding:10px 12px;
  border-radius:14px;
  margin:8px 0;
  font-size:12px;
}

.user{
  margin-left:auto;
  background:rgba(255,255,255,.1);
}

.system{
  background:rgba(0,0,0,.4);
}

textarea{
  width:100%;
  min-height:50px;
  background:rgba(255,255,255,.05);
  color:#fff;
  border:0;
  border-radius:12px;
  padding:10px;
}

.readyGate{
  display:none;
  margin-top:10px;
  padding:12px;
  background:rgba(255,255,255,.04);
  border-radius:14px;
}

.readyGate.show{display:block;}

.readyPrompt{
  font-size:11px;
  letter-spacing:.16em;
  opacity:.7;
  margin-bottom:8px;
}

.readyRow{
  display:flex;
  gap:10px;
}

.readyRow input{
  flex:1;
  background:rgba(255,255,255,.05);
  color:#fff;
  border:0;
  border-radius:12px;
  padding:10px;
  text-transform:uppercase;
}

/* Locked */

.lockedPage{
  position:absolute;
  inset:0;
  background:#000;
  display:none;
  place-items:center;
  z-index:100;
}

body.locked .lockedPage{display:grid;}

.lockedInner{
  background:rgba(0,0,0,.6);
  padding:28px;
  border-radius:18px;
  text-align:center;
}

.lockedInner h2{
  font-size:64px;
  letter-spacing:.22em;
}
</style>
</head>

<body>
<div class="wrap">
<div class="stage">

<video id="vid" autoplay muted playsinline></video>
<div class="portal" id="portal"></div>

<!-- Coward -->
<div class="cowardPage">
<div class="cowardInner">

<div class="cowardTitle">What are you avoiding</div>
<div class="cowardSub">Is the mirror hard to look at?</div>

<div class="chat" id="chat"></div>

<textarea id="confession" placeholder="Type. Enter to send."></textarea>
<button id="enterBtn">Enter</button>

<div class="readyGate" id="readyGate">
<div class="readyPrompt">Are you ready to go back?<br>Type RETURN.</div>
<div class="readyRow">
<input id="returnInput" placeholder="RETURN">
<button id="returnBtn">Enter</button>
<button id="stayBtn">Stay</button>
</div>
</div>

</div>
</div>

<!-- Locked -->
<div class="lockedPage">
<div class="lockedInner">
<h2>LOCKED</h2>
<div>You chose the exit three times.</div>
<a href="#return">Return</a>
</div>
</div>

<!-- HUD -->
<div class="hud">

<div class="top">
<div class="instruction">HOLD STILL, BE PRESENT</div>
<div class="topRight">
<div class="clock" id="clock"></div>
<button class="stopTop" id="stopTop" disabled>Stop</button>
</div>
</div>

<div class="center">
<h1>Spiral in.</h1>
<p id="sub">The gate opens in reflection.</p>
<button id="start">Enable Mirror</button>
<div class="hint" id="hint">Hold still.</div>
</div>

<div class="bottom">
<div id="status">Mirror idle</div>
</div>

</div>
</div>
</div>

<script>
const SECRET_URL="https://www.photonisdead.com/";

const vid=startBtn=stopTop=null;
const video=document.getElementById("vid");
const start=document.getElementById("start");
const stop=document.getElementById("stopTop");
const portal=document.getElementById("portal");
const chat=document.getElementById("chat");
const input=document.getElementById("confession");
const enter=document.getElementById("enterBtn");

const readyGate=document.getElementById("readyGate");
const returnInput=document.getElementById("returnInput");
const returnBtn=document.getElementById("returnBtn");
const stayBtn=document.getElementById("stayBtn");

let stream=null,raf=null;
let still=0,last=null,triggered=false;
let turns=0,ready=false;

const NEED=7000;

let stopCount=Number(localStorage.getItem("stop")||0);
let locked=localStorage.getItem("locked")==="1";

function addBubble(t,c){
  const d=document.createElement("div");
  d.className="bubble "+c;
  d.textContent=t;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

function seed(){
  if(chat.children.length) return;
  addBubble("You looked away.","system");
  addBubble("What are you avoiding?","system");
}

function analyze(t){
  t=t.toLowerCase();

  if(t.match(/fear|anxiety|panic|stress/))
    return "Anxiety is movement without travel.";

  if(t.match(/love|miss|relationship/))
    return "You keep circling them.";

  if(t.match(/money|job|rent|work/))
    return "Survival turns thought into numbers.";

  if(t.match(/art|create|music|make/))
    return "Creation is a confession.";

  return "Say it again. Sharper.";
}

function reply(text){
  const r=analyze(text);
  return r+"\nWhat remains unsaid?";
}

function askReady(){
  ready=true;
  addBubble("Are you ready to go back?","system");
  readyGate.classList.add("show");
  returnInput.focus();
}

function hideReady(){
  ready=false;
  readyGate.classList.remove("show");
}

function send(){
  const t=input.value.trim();
  if(!t) return;

  if(ready){
    hideReady();
    addBubble("Then stay.","system");
  }

  addBubble(t,"user");
  input.value="";

  setTimeout(()=>{
    addBubble(reply(t),"system");
    turns++;

    if(turns%2===0){
      setTimeout(askReady,400);
    }
  },400);
}

function attemptReturn(){
  if(returnInput.value.toUpperCase().trim()==="RETURN"){
    addBubble("Then return.","system");
    setTimeout(()=>{
      document.body.classList.remove("coward");
    },600);
  }else{
    addBubble("Not yet.","system");
    returnInput.value="";
  }
}

function goCoward(){
  stopCount++;
  localStorage.setItem("stop",stopCount);

  if(stopCount>=3){
    locked=true;
    localStorage.setItem("locked","1");
    document.body.classList.add("locked");
    return;
  }

  document.body.classList.add("coward");
  seed();
  input.focus();
}

async function startCam(){
  if(locked) return;

  const s=await navigator.mediaDevices.getUserMedia({video:true});
  stream=s;
  video.srcObject=s;
  await video.play();

  start.disabled=true;
  stop.disabled=false;

  document.body.classList.add("mirroring");
  last=performance.now();
  loop();
}

function stopCam(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  stream=null;
  cancelAnimationFrame(raf);
  document.body.classList.remove("mirroring");
}

function motion(){
  if(!video.videoWidth) return 999;

  const c=document.createElement("canvas");
  c.width=80;c.height=45;
  const ctx=c.getContext("2d");
  ctx.drawImage(video,0,0,80,45);
  const d=ctx.getImageData(0,0,80,45).data;

  if(!last){
    last=d;
    return 999;
  }

  let s=0;
  for(let i=0;i<d.length;i+=12){
    s+=Math.abs(d[i]-last[i]);
  }

  last=d;
  return s/300;
}

let lastT=performance.now();

function loop(){
  if(!stream||locked) return;

  const n=performance.now();
  const dt=n-lastT;
  lastT=n;

  const m=motion();

  if(m<6) still+=dt;
  else still=0;

  if(still>NEED&&!triggered){
    triggered=true;
    portal.classList.add("on");
    setTimeout(()=>{
      window.location.href=SECRET_URL;
    },5200);
  }

  raf=requestAnimationFrame(loop);
}

start.onclick=startCam;
stop.onclick=goCoward;

enter.onclick=send;

input.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){
    e.preventDefault();
    send();
  }
});

returnBtn.onclick=attemptReturn;
stayBtn.onclick=()=>{
  hideReady();
  addBubble("Then stay.","system");
};

returnInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    attemptReturn();
  }
});

if(locked) document.body.classList.add("locked");

seed();
</script>
</body>
</html>
