<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SPIRAL IN</title>

<style>
  html,body{
    height:100%;
    margin:0;
    background:#000;
    color:#fff;
    overflow:hidden;
    font-family:system-ui,Arial,sans-serif;
  }

  .wrap{ height:100%; display:grid; place-items:center; }

  .stage{
    position:relative;
    width:min(92vw,900px);
    aspect-ratio:16/9;
    border-radius:18px;
    overflow:hidden;
    background:#000;
    box-shadow:0 0 60px rgba(0,0,0,.8);
  }

  video{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    transform:scaleX(-1);
    filter: grayscale(100%) contrast(1.16) brightness(1.06);
  }

  .hud{
    position:absolute;
    inset:0;
    display:grid;
    grid-template-rows:auto 1fr auto;
    padding:18px;
    z-index:10;
    pointer-events:none;
  }

  .top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    user-select:none;
  }

  .instruction{
    pointer-events:none;
    display:inline-flex;
    align-items:center;
    padding:10px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.72);
    color:#000;
    font-size:11px;
    letter-spacing:.18em;
    text-transform:uppercase;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.10);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    white-space:nowrap;
  }

  .topRight{
    display:flex;
    align-items:center;
    gap:10px;
    pointer-events:auto;
  }

  .clock{
    font-size:11px;
    letter-spacing:.16em;
    text-transform:uppercase;
    opacity:.55;
  }

  .stopTop{
    border:0;
    border-radius:999px;
    padding:10px 12px;
    background:rgba(255,255,255,.10);
    color:#fff;
    font-size:11px;
    letter-spacing:.15em;
    text-transform:uppercase;
    cursor:pointer;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }
  .stopTop:hover{ background:rgba(255,255,255,.16); }
  .stopTop[disabled]{ opacity:.35; cursor:not-allowed; }

  .center{
    align-self:center;
    justify-self:center;
    background:rgba(0,0,0,.62);
    padding:24px 22px;
    border-radius:16px;
    text-align:center;
    pointer-events:auto;
    transition: transform 700ms cubic-bezier(.14,.9,.18,1), opacity 520ms ease, filter 700ms ease;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    max-width:min(86vw,640px);
  }

  body.mirroring .center{
    transform:translateY(-60vh);
    opacity:0;
    filter:blur(2px);
    pointer-events:none;
  }

  h1{
    margin:0 0 10px;
    letter-spacing:.2em;
    text-transform:uppercase;
    font-size:22px;
  }

  p{
    margin:0 0 16px;
    opacity:.72;
    font-size:13px;
    line-height:1.45;
  }

  .row{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
  }

  button, .btn{
    border:0;
    border-radius:999px;
    padding:10px 14px;
    background:rgba(255,255,255,.10);
    color:#fff;
    font-size:11px;
    letter-spacing:.15em;
    text-transform:uppercase;
    cursor:pointer;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }
  button:hover, .btn:hover{ background:rgba(255,255,255,.18); }
  button[disabled], .btn[disabled]{ opacity:.35; cursor:not-allowed; }

  .hint{
    margin-top:12px;
    font-size:12px;
    opacity:.58;
    letter-spacing:.10em;
    user-select:none;
  }

  /* Fail whisper (non-stop failures) */
  .fail{
    margin-top:6px;
    font-size:11px;
    opacity:0;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:rgba(255,255,255,.55);
    transition: opacity 1.2s ease;
    user-select:none;
  }
  .fail.show{ opacity:1; }

  .bottom{
    display:flex;
    justify-content:space-between;
    font-size:11px;
    letter-spacing:.15em;
    text-transform:uppercase;
    opacity:.55;
    user-select:none;
  }

  .portal{
    position:absolute;
    inset:0;
    pointer-events:none;
    opacity:0;
    z-index:50;
  }

  .portal.on{
    opacity:1;
    animation: fall 5600ms cubic-bezier(.10,.92,.16,1) forwards;
  }

  .portal::before{
    content:"";
    position:absolute;
    inset:-35%;
    background:
      repeating-radial-gradient(circle,
        #fff 0px,
        #fff 7px,
        #000 7px,
        #000 22px);
    transform-origin: 50% 50%;
    animation:
      slowSpin 42000ms linear infinite,
      slowBreath 8200ms ease-in-out infinite;
    filter: contrast(1.22);
    mask-image: radial-gradient(circle,#000 0%,#000 72%,transparent 90%);
    -webkit-mask-image: radial-gradient(circle,#000 0%,#000 72%,transparent 90%);
  }

  .portal::after{
    content:"";
    position:absolute;
    inset:0;
    background:radial-gradient(circle,
      rgba(0,0,0,0) 0%,
      rgba(0,0,0,.28) 58%,
      #000 100%);
  }

  @keyframes slowSpin{
    from{ transform: rotate(0deg) scale(0.95); }
    to  { transform: rotate(360deg) scale(1.06); }
  }

  @keyframes slowBreath{
    0%   { filter: contrast(1.12) brightness(1.00); }
    50%  { filter: contrast(1.28) brightness(1.04); }
    100% { filter: contrast(1.12) brightness(1.00); }
  }

  @keyframes fall{
    0%   { transform: scale(1.0); filter: blur(0px); }
    30%  { transform: scale(1.05); filter: blur(0.20px); }
    65%  { transform: scale(1.18); filter: blur(0.55px); }
    100% { transform: scale(2.00); filter: blur(1.25px); }
  }

  /* ===== Coward “page” (Stop 1-2) — confession chat ===== */
  .cowardPage{
    position:absolute;
    inset:0;
    background:#000;
    z-index:100;
    display:none;
    overflow:hidden;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  body.coward .cowardPage{ display:flex; }

  .cowardPage::before{
    content:"";
    position:absolute;
    inset:-18%;
    opacity:.14;
    background:
      repeating-radial-gradient(circle,
        rgba(255,255,255,1) 0px,
        rgba(255,255,255,1) 2px,
        rgba(0,0,0,1) 2px,
        rgba(0,0,0,1) 20px);
    transform: rotate(-8deg) scale(1.2);
    filter: blur(0.35px) contrast(1.05);
  }

  .cowardInner{
    position:relative;
    text-align:left;
    padding:22px 20px;
    border-radius:18px;
    background:rgba(0,0,0,.62);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    max-width:min(90vw,760px);
    width:min(90vw,760px);
  }

  .cowardTitle{
    margin:0 0 6px;
    font-size:18px;
    letter-spacing:.18em;
    text-transform:uppercase;
  }

  .cowardSub{
    margin:0 0 14px;
    opacity:.70;
    letter-spacing:.10em;
    text-transform:uppercase;
    font-size:11px;
    line-height:1.35;
  }

  .chat{
    height:min(42vh,320px);
    overflow:auto;
    padding:12px;
    border-radius:14px;
    background:rgba(255,255,255,.04);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    margin-bottom:12px;
  }

  .bubble{
    max-width: 82%;
    padding:10px 12px;
    border-radius:14px;
    margin:8px 0;
    font-size:12px;
    line-height:1.45;
    letter-spacing:.02em;
    white-space:pre-wrap;
    word-wrap:break-word;
  }

  .bubble.user{
    margin-left:auto;
    background:rgba(255,255,255,.10);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
  }

  .bubble.system{
    margin-right:auto;
    background:rgba(0,0,0,.35);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
    opacity:.92;
  }

  .label{
    font-size:11px;
    letter-spacing:.16em;
    text-transform:uppercase;
    opacity:.70;
    margin:0 0 6px;
  }

  .inputRow{
    display:flex;
    gap:10px;
    align-items:flex-end;
  }

  textarea{
    flex:1;
    resize:none;
    min-height:52px;
    max-height:140px;
    padding:12px 12px;
    border-radius:14px;
    border:0;
    outline:none;
    background:rgba(255,255,255,.06);
    color:#fff;
    font-size:12px;
    line-height:1.45;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }

  .enterBtn{
    padding:12px 14px;
    border-radius:14px;
    background:rgba(255,255,255,.10);
    min-width:88px;
    height:52px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
  }

  .choiceRow{
    display:none;
    gap:10px;
    margin-top:10px;
    justify-content:flex-end;
  }

  .ghostBtn{
    background:rgba(255,255,255,.08);
  }

  .cowardBtns{
    display:flex;
    gap:10px;
    margin-top:12px;
    justify-content:flex-end;
  }

  /* ===== LOCKED “fail page” after 3 Stops ===== */
  .lockedPage{
    position:absolute;
    inset:0;
    background:#000;
    z-index:120;
    display:none;
    overflow:hidden;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
  }
  body.locked .lockedPage{ display:flex; }

  .lockedPage::before{
    content:"";
    position:absolute;
    inset:-20%;
    opacity:.10;
    background:
      repeating-radial-gradient(circle,
        rgba(255,255,255,1) 0px,
        rgba(255,255,255,1) 2px,
        rgba(0,0,0,1) 2px,
        rgba(0,0,0,1) 18px);
    transform: rotate(9deg) scale(1.25);
    filter: blur(0.35px) contrast(1.1);
  }

  .lockedInner{
    position:relative;
    text-align:center;
    padding:30px 22px;
    border-radius:18px;
    background:rgba(0,0,0,.62);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    max-width:min(86vw,760px);
  }

  .lockedInner h2{
    margin:0 0 12px;
    font-size: clamp(44px, 7vw, 96px);
    letter-spacing:.22em;
    text-transform:uppercase;
    line-height:1;
  }

  .lockedInner .small{
    margin:0 0 18px;
    opacity:.62;
    letter-spacing:.12em;
    text-transform:uppercase;
    font-size:12px;
    line-height:1.35;
  }

  .lockedInner a{
    display:inline-block;
    border-radius:999px;
    padding:12px 16px;
    background:rgba(255,255,255,.12);
    color:#fff;
    font-size:11px;
    letter-spacing:.15em;
    text-transform:uppercase;
    text-decoration:none;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
  }
  .lockedInner a:hover{ background:rgba(255,255,255,.18); }

  @media(max-width:520px){
    .stage{ aspect-ratio:9/16; }
    body.mirroring .center{ transform:translateY(-80vh); }
    .instruction{ font-size:10px; letter-spacing:.14em; padding:9px 10px; }
    .chat{ height:min(46vh,360px); }
    .enterBtn{ min-width:78px; }
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="stage">
    <video id="vid" autoplay muted playsinline></video>

    <div class="portal" id="portal"></div>

    <!-- Coward page -> confession chat (STOP #1 and #2 only) -->
    <div class="cowardPage" id="cowardPage">
      <div class="cowardInner">
        <div class="cowardTitle">What are you avoiding</div>
        <div class="cowardSub">Is the mirror hard to look at?</div>

        <div class="chat" id="chat"></div>

        <div class="label">Answer.</div>
        <div class="inputRow">
          <textarea id="confession" placeholder="type here... (Enter to send, Shift+Enter for a new line)"></textarea>
          <button class="enterBtn" id="enterBtn">Enter</button>
        </div>

        <div class="choiceRow" id="choiceRow">
          <button id="readyYes">Yes</button>
          <button class="ghostBtn" id="readyNo">No</button>
        </div>

        <div class="cowardBtns">
          <button class="ghostBtn" id="backBtn">Go back</button>
        </div>
      </div>
    </div>

    <!-- Locked after 3 Stops -->
    <div class="lockedPage" id="lockedPage">
      <div class="lockedInner">
        <h2>LOCKED</h2>
        <div class="small">You chose the exit three times.<br>The gate will not open.</div>
        <a href="#return" id="returnLink">Return and try again</a>
      </div>
    </div>

    <!-- Main HUD -->
    <div class="hud">
      <div class="top">
        <div class="instruction">HOLD STILL, BE PRESENT</div>
        <div class="topRight">
          <div class="clock" id="clock">—</div>
          <button class="stopTop" id="stopTop" disabled>Stop</button>
        </div>
      </div>

      <div class="center">
        <h1>Spiral in.</h1>
        <p id="sub">The gate opens in reflection.</p>
        <div class="row">
          <button id="start">Enable Mirror</button>
        </div>
        <div class="hint" id="hint">Hold still.</div>
        <div class="fail" id="fail"></div>
      </div>

      <div class="bottom">
        <div id="status">Mirror idle</div>
        <div></div>
      </div>
    </div>

  </div>
</div>

<script>
  const SECRET_URL = "https://www.photonisdead.com/";

  const vid = document.getElementById("vid");
  const startBtn = document.getElementById("start");
  const stopTop = document.getElementById("stopTop");

  const hint = document.getElementById("hint");
  const sub = document.getElementById("sub");
  const statusEl = document.getElementById("status");
  const portal = document.getElementById("portal");
  const clock = document.getElementById("clock");

  // Coward chat elements
  const chatEl = document.getElementById("chat");
  const confessionEl = document.getElementById("confession");
  const enterBtn = document.getElementById("enterBtn");
  const backBtn = document.getElementById("backBtn");
  const choiceRow = document.getElementById("choiceRow");
  const readyYes = document.getElementById("readyYes");
  const readyNo = document.getElementById("readyNo");

  // ===== Versioned storage reset (prevents old localStorage causing weird behavior) =====
  const STORAGE_VERSION = "spiral_gate_v5";
  const VERSION_KEY = "spiral_storage_version";
  if (localStorage.getItem(VERSION_KEY) !== STORAGE_VERSION){
    localStorage.setItem(VERSION_KEY, STORAGE_VERSION);
    localStorage.setItem("spiral_stop_count", "0");
    localStorage.removeItem("spiral_locked");
    localStorage.removeItem("spiral_coward_chat_state");
  }

  // ===== Fail whisper (stillness fails, camera denied, etc.) =====
  const failEl = document.getElementById("fail");
  const FAIL_KEY = "spiral_fail_count";
  let failCount = Number(localStorage.getItem(FAIL_KEY) || 0);
  if (!Number.isFinite(failCount)) failCount = 0;

  const failMessages = [
    "You weren’t ready.",
    "Return when quiet.",
    "The spiral remembers."
  ];

  function showFail(){
    if (failCount < 3) {
      failEl.textContent = "";
      failEl.classList.remove("show");
      return;
    }
    const idx = Math.min(failMessages.length - 1, failCount - 3);
    failEl.textContent = failMessages[idx];
    failEl.classList.add("show");
  }

  function registerFail(){
    failCount += 1;
    localStorage.setItem(FAIL_KEY, String(failCount));
    showFail();
  }

  function clearFail(){
    failCount = 0;
    localStorage.removeItem(FAIL_KEY);
    failEl.textContent = "";
    failEl.classList.remove("show");
  }

  // ===== STOP lockout after 3 stops =====
  const STOP_KEY = "spiral_stop_count";
  const LOCK_KEY = "spiral_locked";
  let stopCount = Number(localStorage.getItem(STOP_KEY) || 0);
  if (!Number.isFinite(stopCount)) stopCount = 0;
  let locked = (localStorage.getItem(LOCK_KEY) === "1");

  function applyLockedUI(){
    if (locked){
      document.body.classList.add("locked");
      startBtn.disabled = true;
      stopTop.disabled = true;
      statusEl.textContent = "Locked";
      hint.textContent = "Return and try again.";
      sub.textContent = "The gate will not open.";
    } else {
      document.body.classList.remove("locked");
    }
  }

  function lockNow(){
    locked = true;
    localStorage.setItem(LOCK_KEY, "1");
    document.body.classList.add("locked");
    stopCam(true);
    applyLockedUI();
  }

  function unlockNow(){
    locked = false;
    stopCount = 0;
    localStorage.setItem(STOP_KEY, "0");
    localStorage.removeItem(LOCK_KEY);
    document.body.classList.remove("locked");
    document.body.classList.remove("coward");
    location.hash = "";
    resetGate();
    applyLockedUI();
    statusEl.textContent = "Mirror idle";
    hint.textContent = "Hold still.";
    sub.textContent = "The gate opens in reflection.";
    showFail();
  }

  function registerStop(){
    stopCount += 1;
    localStorage.setItem(STOP_KEY, String(stopCount));
    if (stopCount >= 3){
      lockNow();
      return true;
    }
    return false;
  }

  let stream = null;
  let raf = null;

  // ===== Motion detection =====
  const mCan = document.createElement("canvas");
  mCan.width = 96;
  mCan.height = 54;
  const mCtx = mCan.getContext("2d", { willReadFrequently: true });

  let last = null;
  let stillMs = 0;
  let triggered = false;

  const NEED = 7000;

  const STILL_THRESH = 6.0;
  const MOVE_THRESH  = 12.0;
  const FINISH_QUIET  = 6.0;

  const PORTAL_DELAY = 240;

  const AUDIO_FADE_MS = 1400;
  const PORTAL_TOTAL_MS = 5600;
  const REDIRECT_AFTER = Math.max(900, PORTAL_TOTAL_MS - 250);

  // ===== Ambient sound (procedural) =====
  let audioCtx = null, master = null;
  let droneOsc = null, shimmerOsc = null, lfo = null, lfoGain = null;

  function startAmbient(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    master = audioCtx.createGain();
    master.gain.value = 0.0;
    master.connect(audioCtx.destination);

    droneOsc = audioCtx.createOscillator();
    droneOsc.type = "sine";
    droneOsc.frequency.value = 46;

    const droneGain = audioCtx.createGain();
    droneGain.gain.value = 0.28;

    shimmerOsc = audioCtx.createOscillator();
    shimmerOsc.type = "triangle";
    shimmerOsc.frequency.value = 176;

    const shimmerGain = audioCtx.createGain();
    shimmerGain.gain.value = 0.045;

    lfo = audioCtx.createOscillator();
    lfo.type = "sine";
    lfo.frequency.value = 0.06;

    lfoGain = audioCtx.createGain();
    lfoGain.gain.value = 9.5;

    lfo.connect(lfoGain);
    lfoGain.connect(droneOsc.frequency);

    droneOsc.connect(droneGain);
    shimmerOsc.connect(shimmerGain);

    droneGain.connect(master);
    shimmerGain.connect(master);

    droneOsc.start();
    shimmerOsc.start();
    lfo.start();

    master.gain.setValueAtTime(0.0, audioCtx.currentTime);
    master.gain.linearRampToValueAtTime(0.22, audioCtx.currentTime + 1.2);
  }

  function fadeOutAmbient(ms){
    if (!audioCtx || !master) return;
    const t = audioCtx.currentTime;
    const dur = Math.max(0.05, ms / 1000);

    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(master.gain.value, t);
    master.gain.linearRampToValueAtTime(0.0001, t + dur);

    try{
      shimmerOsc.frequency.cancelScheduledValues(t);
      shimmerOsc.frequency.setTargetAtTime(140, t, 1.0);
    }catch(_){}
  }

  function stopAmbient(){
    if (!audioCtx) return;
    const t = audioCtx.currentTime;
    master.gain.cancelScheduledValues(t);
    master.gain.setValueAtTime(master.gain.value, t);
    master.gain.linearRampToValueAtTime(0.0, t + 0.35);

    setTimeout(() => {
      try{ droneOsc?.stop(); shimmerOsc?.stop(); lfo?.stop(); }catch(_){}
      audioCtx.close().catch(()=>{});
      audioCtx = null; master = null;
      droneOsc = null; shimmerOsc = null; lfo = null; lfoGain = null;
    }, 450);
  }

  function setClock(){
    const d=new Date();
    clock.textContent =
      d.getHours().toString().padStart(2,"0") + ":" +
      d.getMinutes().toString().padStart(2,"0") + ":" +
      d.getSeconds().toString().padStart(2,"0");
  }
  setClock();
  setInterval(setClock, 350);

  function resetGate(){
    portal.classList.remove("on");
    triggered = false;
    stillMs = 0;
    last = null;
  }

  function beginPortal(){
    if (triggered || locked) return;
    triggered = true;

    clearFail();

    // success resets stop counter
    stopCount = 0;
    localStorage.setItem(STOP_KEY, "0");

    hint.textContent = "Falling inward.";
    sub.textContent = "Recognized.";

    if (audioCtx && master){
      const t = audioCtx.currentTime;
      master.gain.cancelScheduledValues(t);
      master.gain.setValueAtTime(master.gain.value, t);
      master.gain.linearRampToValueAtTime(0.30, t + 0.9);
    }

    setTimeout(() => {
      portal.classList.add("on");

      const fadeAt = Math.max(0, REDIRECT_AFTER - AUDIO_FADE_MS);
      setTimeout(() => fadeOutAmbient(AUDIO_FADE_MS), fadeAt);

      setTimeout(() => {
        window.location.href = SECRET_URL;
      }, REDIRECT_AFTER);

    }, PORTAL_DELAY);
  }

  async function startCam(){
    if (locked){
      applyLockedUI();
      return;
    }

    if (location.hash === "#coward") location.hash = "";
    resetGate();
    document.body.classList.remove("coward");
    document.body.classList.remove("mirroring");

    showFail();

    try{
      startAmbient();

      stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      vid.srcObject = stream;
      await vid.play();

      startBtn.disabled = true;
      stopTop.disabled = false;

      statusEl.textContent = "Mirror active";
      hint.textContent = "Hold still. Be present.";
      sub.textContent = "The gate opens in reflection.";

      document.body.classList.add("mirroring");

      lastT = performance.now();
      loop();
    }catch(e){
      statusEl.textContent = "Denied";
      hint.textContent = "Reflection required.";
      startBtn.disabled = false;
      stopTop.disabled = true;

      registerFail();
      stopAmbient();
    }
  }

  function stopCam(){
    if (raf) cancelAnimationFrame(raf);
    raf = null;

    if (stream){
      stream.getTracks().forEach(t => t.stop());
    }
    stream = null;

    startBtn.disabled = locked ? true : false;
    stopTop.disabled = true;

    statusEl.textContent = locked ? "Locked" : "Mirror stopped";
    hint.textContent = locked ? "Return and try again." : "Look inward.";

    document.body.classList.remove("mirroring");
    resetGate();
    stopAmbient();
  }

  /* ============================
     Coward Chat (scripted pseudo-AI, neutral/cryptic)
     - 10 theme modules + fallback
     - Ask “are you ready to go back?” every 2 user messages
  ============================ */
  const CHAT_KEY = "spiral_coward_chat_state";
  let chatState = JSON.parse(localStorage.getItem(CHAT_KEY) || "null") || {
    turns: 0,        // number of user messages sent in coward chat
    readyAsked: false
  };

  function saveChatState(){ localStorage.setItem(CHAT_KEY, JSON.stringify(chatState)); }
  function scrollChat(){ chatEl.scrollTop = chatEl.scrollHeight; }

  function addBubble(text, who){
    const div = document.createElement("div");
    div.className = "bubble " + who;
    div.textContent = text;
    chatEl.appendChild(div);
    scrollChat();
  }

  function seedChatIfEmpty(){
    if (chatEl.children.length) return;
    addBubble("You looked away.", "system");
    addBubble("What are you avoiding?", "system");
  }

  function cleanWords(text){
    return (text || "")
      .toLowerCase()
      .replace(/[^a-z0-9\s'’-]/g, " ")
      .split(/\s+/)
      .filter(Boolean);
  }

  function pickEcho(text){
    const words = cleanWords(text).filter(w => w.length >= 4);
    if (!words.length) return "";
    // pick 1 word near the end to feel “listening”
    const w = words[Math.max(0, words.length - 2)];
    return w ? `"${w}"` : "";
  }

  const THEMES = [
    {
      name: "anxiety",
      keys: ["anxiety","panic","stress","worried","worry","overthink","overthinking","fear","scared","terrified","nervous"],
      lines: [
        "Anxiety is movement without travel.\nName the place you keep running to.",
        "Your mind calls it “stress.”\nYour body calls it “alarm.”"
      ]
    },
    {
      name: "avoidance",
      keys: ["avoid","avoiding","procrastinate","procrastination","later","tomorrow","stall","stuck","paralyzed","freeze","postpone"],
      lines: [
        "Avoidance is a ritual.\nWhat do you do instead of beginning?",
        "If you started today, what would collapse?"
      ]
    },
    {
      name: "love",
      keys: ["love","relationship","breakup","heart","girlfriend","boyfriend","husband","wife","her","him","they","miss","attachment"],
      lines: [
        "You keep circling them.\nThe spiral keeps circling you.",
        "What are you hoping they prove about you?"
      ]
    },
    {
      name: "shame",
      keys: ["shame","guilt","regret","embarrassed","humiliated","fault","blame","sorry","mistake"],
      lines: [
        "Shame survives on the unsaid.\nSay the simplest version.",
        "Guilt can be a compass—or a cage.\nWhich one did you build?"
      ]
    },
    {
      name: "money",
      keys: ["money","rent","bills","debt","broke","poor","job","career","work","paycheck","pay","income"],
      lines: [
        "Survival turns every thought into a number.\nWhat does “enough” look like in silence?",
        "You can’t budget your way out of emptiness.\nBut you can name what it costs you."
      ]
    },
    {
      name: "grief",
      keys: ["death","dying","mortality","grief","funeral","cemetery","lost","loss","gone","missed","sick"],
      lines: [
        "You don’t fear death.\nYou fear being unfinished.",
        "What are you trying to outlive?"
      ]
    },
    {
      name: "identity",
      keys: ["identity","who","am","i","self","worth","confidence","insecure","imposter","impostor","meaning","purpose"],
      lines: [
        "You keep asking who you are.\nTry: what do you refuse to be?",
        "If nobody watched, what would remain true?"
      ]
    },
    {
      name: "anger",
      keys: ["angry","anger","mad","rage","furious","hate","resent","resentment","betrayed"],
      lines: [
        "Anger is often grief wearing armor.\nWhat is it protecting?",
        "Who benefits from your silence?"
      ]
    },
    {
      name: "body",
      keys: ["tired","exhausted","sleep","insomnia","pain","sick","body","ache","hurt","burnout","burned","burnt"],
      lines: [
        "Your body is the part of you that can’t lie.\nWhere is the weight?",
        "Rest is not a reward.\nIt’s a baseline you were denied."
      ]
    },
    {
      name: "creation",
      keys: ["art","create","creating","music","song","paint","draw","writing","write","project","nft","drop","work","make"],
      lines: [
        "Creation is a confession you can pretend is aesthetic.\nWhat are you smuggling inside it?",
        "You want the work to speak.\nWhat are you afraid it will say?"
      ]
    }
  ];

  const FALLBACK = [
    "Say it again, shorter.\nMake it sharp.",
    "Don’t explain.\nPoint to the center.",
    "What is the sentence you keep refusing to write?"
  ];

  function bestTheme(text){
    const words = cleanWords(text);
    if (!words.length) return null;

    // score each theme by keyword matches
    let best = null;
    let bestScore = 0;
    for (const t of THEMES){
      let score = 0;
      for (const k of t.keys){
        if (words.includes(k)) score++;
      }
      if (score > bestScore){
        bestScore = score;
        best = t;
      }
    }
    return bestScore > 0 ? best : null;
  }

  function pickLine(arr){
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function replyFor(text){
    const echo = pickEcho(text);
    const theme = bestTheme(text);

    let line;
    if (theme){
      line = pickLine(theme.lines);
    } else {
      line = pickLine(FALLBACK);
    }

    // subtle “listening” echo, but only sometimes (keeps it from feeling templated)
    const shouldEcho = echo && Math.random() < 0.55;
    if (shouldEcho){
      return `You said ${echo}.\n${line}`;
    }
    return line;
  }

  function askReady(){
    chatState.readyAsked = true;
    saveChatState();
    addBubble("Are you ready to go back?", "system");
    choiceRow.style.display = "flex";
    scrollChat();
  }

  function clearReady(){
    chatState.readyAsked = false;
    saveChatState();
    choiceRow.style.display = "none";
  }

  function enterCoward(){
    document.body.classList.add("coward");
    seedChatIfEmpty();
    confessionEl.focus();
    // If a previous session was mid-ready, restore choices
    if (chatState.readyAsked) {
      choiceRow.style.display = "flex";
      scrollChat();
    }
  }

  function leaveCoward(){
    document.body.classList.remove("coward");
    location.hash = "";
  }

  function handleSend(){
    if (locked) return;

    const text = confessionEl.value.trim();
    if (!text) return;

    // If we’re waiting for ready yes/no, treat typing as “No” implicitly (keep it moving)
    if (chatState.readyAsked){
      clearReady();
      addBubble("Then stay.", "system");
    }

    addBubble(text, "user");
    confessionEl.value = "";

    const reply = replyFor(text);

    setTimeout(() => {
      addBubble(reply, "system");

      chatState.turns += 1;
      saveChatState();

      // Ask “ready” every 2 user messages: 2, 4, 6, ...
      if (chatState.turns % 2 === 0){
        setTimeout(askReady, 380);
      }
    }, 420);
  }

  /* ============================
     Stop behavior and routing
  ============================ */
  function goCoward(){
    // Stop #1 and #2 => coward chat
    // Stop #3 => locked page
    const nowLocked = registerStop();
    stopCam();

    if (nowLocked){
      location.hash = "#locked";
      document.body.classList.add("locked");
      document.body.classList.remove("coward");
      applyLockedUI();
      return;
    }

    location.hash = "#coward";
    enterCoward();
  }

  function backFromCoward(){
    leaveCoward();
    statusEl.textContent = "Mirror idle";
    hint.textContent = "Hold still.";
    sub.textContent = "The gate opens in reflection.";
    showFail();
  }

  function motionScore(){
    if (!vid.videoWidth || !vid.videoHeight) return 999;

    mCtx.drawImage(vid, 0, 0, mCan.width, mCan.height);
    const f = mCtx.getImageData(0, 0, mCan.width, mCan.height);

    if (!last){
      last = f;
      return 999;
    }

    const A = f.data;
    const B = last.data;

    let sum = 0;
    let count = 0;

    for (let i = 0; i < A.length; i += 12){
      sum += Math.abs(A[i] - B[i]);
      count++;
    }

    last = f;
    return sum / Math.max(1, count);
  }

  let lastT = performance.now();
  function loop(){
    if (!stream || locked) return;

    const now = performance.now();
    const dt = now - lastT;
    lastT = now;

    const m = motionScore();

    if (m > MOVE_THRESH){
      stillMs = 0;
    } else if (m < STILL_THRESH){
      stillMs += dt;
    } else {
      stillMs = Math.max(0, stillMs - dt * 0.65);
    }

    if (!triggered){
      if (stillMs < 2000) hint.textContent = "Hold still. Be present.";
      else if (stillMs < 4500) hint.textContent = "Stay.";
      else if (stillMs < NEED) hint.textContent = "…";
      else {
        if (m < FINISH_QUIET) beginPortal();
        else stillMs = 0;
      }
    }

    raf = requestAnimationFrame(loop);
  }

  function syncRoute(){
    if (location.hash === "#coward"){
      document.body.classList.add("coward");
      document.body.classList.remove("locked");
      enterCoward();
    } else if (location.hash === "#locked"){
      document.body.classList.add("locked");
      document.body.classList.remove("coward");
    } else if (location.hash === "#return"){
      unlockNow();
    } else {
      document.body.classList.remove("coward");
      document.body.classList.remove("locked");
    }
  }
  window.addEventListener("hashchange", syncRoute);

  // Controls
  startBtn.onclick = startCam;
  stopTop.onclick = goCoward;

  backBtn.onclick = backFromCoward;
  enterBtn.onclick = handleSend;

  confessionEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      handleSend();
    }
  });

  readyYes.onclick = () => {
    addBubble("Then return.", "system");
    clearReady();
    setTimeout(() => {
      backFromCoward();
    }, 650);
  };

  readyNo.onclick = () => {
    addBubble("Then stay with it.", "system");
    clearReady();
    confessionEl.focus();
  };

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stopCam();
  });

  // Load
  if (locked){
    location.hash = "#locked";
  }
  showFail();
  applyLockedUI();
  syncRoute();

  seedChatIfEmpty();
</script>

</body>
</html>

